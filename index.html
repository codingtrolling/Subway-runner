<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Subway Runner - Online Edition</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; touch-action: none; }
        #ui { position: absolute; top: 15px; left: 15px; color: white; font-size: 20px; font-weight: bold; text-shadow: 2px 2px #000; z-index: 10; }
        #menu { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .btn { padding: 15px 40px; background: #00ffcc; border: none; border-radius: 10px; font-weight: bold; margin-top: 20px; color: black; font-size: 18px; }
        #profile-pic { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #00ffcc; display: none; margin-bottom: 10px; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 110; color: white; }
    </style>
</head>
<body>

    <div id="ui">Score: <span id="score">0</span></div>

    <div id="menu">
        <img id="profile-pic" src="" alt="user">
        <h1 id="title">SUBWAY RUNNER</h1>
        
        <div id="g_id_onload"
             data-client_id="778775023056-dnrr0d6ujirr01cs0vclfd6gpgseh7kl.apps.googleusercontent.com"
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard"></div>

        <button class="btn" id="start-btn" style="display:none;">START RUN</button>
        <p style="font-size: 12px; margin-top: 20px; opacity: 0.6;">Swipe Up: Jump | Down: Crouch | Side: Move</p>
    </div>

    <div id="overlay">
        <h1>CRASHED!</h1>
        <button class="btn" onclick="location.reload()">RESTART</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- GOOGLE LOGIN ---
        window.handleCredentialResponse = (response) => {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            document.getElementById('title').innerText = "Runner: " + payload.given_name;
            document.getElementById('start-btn').style.display = "block";
            const pic = document.getElementById('profile-pic');
            pic.src = payload.picture;
            pic.style.display = "block";

            new THREE.TextureLoader().load(payload.picture, (t) => {
                playerBody.material.map = t;
                playerBody.material.needsUpdate = true;
            });
        };

        // --- GAME ENGINE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 10, 5);
        scene.add(light);

        // Character Group
        const playerGroup = new THREE.Group();
        const playerBody = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 0.6), new THREE.MeshStandardMaterial({ color: 0xffffff }));
        playerBody.position.y = 0.75;
        playerGroup.add(playerBody);
        scene.add(playerGroup);

        // Road
        const road = new THREE.Mesh(new THREE.PlaneGeometry(10, 1000), new THREE.MeshStandardMaterial({ color: 0x333333 }));
        road.rotation.x = -Math.PI / 2;
        scene.add(road);

        // Game State
        let gameActive = false, score = 0, currentLane = 0, gameSpeed = 0.5;
        const lanes = [-2.5, 0, 2.5];
        const obstacles = [];

        // Obstacle Spawner
        function spawnObstacle() {
            if (!gameActive) return;
            const geo = new THREE.BoxGeometry(1.5, 1.5, 1.5);
            const mat = new THREE.MeshStandardMaterial({ color: 0xff4400 });
            const box = new THREE.Mesh(geo, mat);
            box.position.set(lanes[Math.floor(Math.random() * 3)], 0.75, -100);
            scene.add(box);
            obstacles.push(box);
            setTimeout(spawnObstacle, 2000 - (score/10));
        }

        // --- CONTROLS ---
        let sX, sY;
        window.addEventListener('touchstart', e => { sX = e.touches[0].clientX; sY = e.touches[0].clientY; });
        window.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - sX, dy = e.changedTouches[0].clientY - sY;
            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 40 && currentLane < 1) currentLane++;
                else if (dx < -40 && currentLane > -1) currentLane--;
            } else {
                if (dy < -40) jump();
                else if (dy > 40) crouch();
            }
        });

        function jump() {
            if (playerGroup.position.y > 0.1) return;
            let v = 0.35;
            const j = () => {
                playerGroup.position.y += v; v -= 0.02;
                if (playerGroup.position.y > 0) requestAnimationFrame(j);
                else playerGroup.position.y = 0;
            }; j();
        }

        function crouch() {
            playerGroup.scale.y = 0.5;
            setTimeout(() => playerGroup.scale.y = 1, 600);
        }

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('menu').style.display = 'none';
            gameActive = true;
            spawnObstacle();
            animate();
        };

        function animate() {
            if (!gameActive) return;
            requestAnimationFrame(animate);

            // Smooth Movement
            playerGroup.position.x += (lanes[currentLane + 1] - playerGroup.position.x) * 0.15;
            
            // Handle Obstacles
            obstacles.forEach((obj, index) => {
                obj.position.z += gameSpeed;
                // Collision
                const pBox = new THREE.Box3().setFromObject(playerGroup);
                const oBox = new THREE.Box3().setFromObject(obj);
                if (pBox.intersectsBox(oBox)) {
                    gameActive = false;
                    document.getElementById('overlay').style.display = "flex";
                }
                // Cleanup
                if (obj.position.z > 20) {
                    scene.remove(obj);
                    obstacles.splice(index, 1);
                }
            });

            score++;
            document.getElementById('score').innerText = Math.floor(score/10);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
